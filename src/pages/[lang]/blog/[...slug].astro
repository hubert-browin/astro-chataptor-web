---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getBlogUI } from '../../../i18n/blog';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map(post => ({
    params: { 
        lang: post.data.lang, 
        slug: post.slug.split('/')[0] 
    },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await post.render();
const ui = getBlogUI(post.data.lang);

// Formatowanie daty
const formattedDate = new Intl.DateTimeFormat(post.data.lang, { 
    day: 'numeric', month: 'long', year: 'numeric' 
}).format(post.data.publishedAt);

// Obliczanie czasu czytania (szacunkowo)
const wordCount = post.body.split(/\s+/g).length;
const readTime = Math.ceil(wordCount / 200);
---

<BaseLayout 
    title={post.data.title} 
    description={post.data.description}
    lang={post.data.lang}
>
    <!-- Postęp czytania (Pasek na górze) -->
    <div id="progress-bar" class="fixed top-0 left-0 h-1 bg-emerald-500 z-[100] w-0 transition-all duration-100 ease-out"></div>

    <article class="bg-white min-h-screen pb-20">
        
        {/* --- HERO SEKCJA --- */}
        <div class="relative pt-32 pb-12 md:pt-40 md:pb-24 px-6 overflow-hidden">
            {/* Tło ambientowe */}
            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full max-w-7xl h-[500px] bg-gradient-to-b from-zinc-50/80 to-white -z-10 pointer-events-none"></div>
            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-[800px] h-[400px] bg-emerald-100/30 blur-[120px] rounded-full -z-10 mix-blend-multiply pointer-events-none"></div>

            {/* Zmiana: max-w-4xl -> max-w-5xl (szerszy nagłówek) */}
            <div class="max-w-5xl mx-auto text-center relative z-10">
                {/* Powrót */}
                <a href={`/${post.data.lang}/blog`} class="inline-flex items-center gap-2 text-sm font-bold text-zinc-400 hover:text-zinc-900 transition-colors mb-8 group">
                    <span class="w-8 h-8 rounded-full bg-white ring-1 ring-zinc-200 flex items-center justify-center group-hover:ring-zinc-900 transition-all">←</span>
                    {ui.backToBlog}
                </a>

                {/* Tagi */}
                <div class="flex flex-wrap justify-center gap-2 mb-6">
                    {post.data.tags.map(tag => (
                        <span class="px-3 py-1 bg-white ring-1 ring-zinc-200 rounded-full text-[11px] font-bold text-emerald-700 uppercase tracking-wider shadow-sm">
                            {tag}
                        </span>
                    ))}
                </div>

                {/* Tytuł */}
                <h1 class="text-4xl sm:text-5xl md:text-6xl lg:text-7xl font-extrabold text-zinc-900 tracking-tight leading-[1.1] mb-8 text-balance">
                    {post.data.title}
                </h1>

                {/* Metadane Autora */}
                <div class="flex flex-col sm:flex-row items-center justify-center gap-4 sm:gap-8 text-sm text-zinc-500 border-t border-zinc-100 pt-8 w-fit mx-auto px-8">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-zinc-100 flex items-center justify-center text-zinc-500 font-bold ring-2 ring-white shadow-sm">
                            {post.data.author.charAt(0)}
                        </div>
                        <div class="text-left">
                            <div class="font-bold text-zinc-900">{post.data.author}</div>
                            <div class="text-xs">Autor</div>
                        </div>
                    </div>
                    <div class="hidden sm:block w-px h-8 bg-zinc-200"></div>
                    <div class="flex items-center gap-6">
                        <div class="flex flex-col text-left">
                            <span class="font-bold text-zinc-900">{formattedDate}</span>
                            <span class="text-xs">{ui.card.published}</span>
                        </div>
                        <div class="flex flex-col text-left">
                            <span class="font-bold text-zinc-900">{readTime} min</span>
                            <span class="text-xs">Czas czytania</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {/* --- ZDJĘCIE GŁÓWNE (Szerokie) --- */}
        {/* Zmiana: max-w-6xl -> max-w-7xl (wyrównanie do standardowego kontenera strony) */}
        {post.data.image && (
            <div class="max-w-7xl mx-auto px-4 md:px-6 mb-16 md:mb-24">
                <div class="aspect-[21/9] rounded-[2rem] md:rounded-[3rem] overflow-hidden shadow-2xl shadow-zinc-200/50 ring-1 ring-black/5 relative group">
                    <img 
                        src={post.data.image} 
                        alt={post.data.title} 
                        class="absolute inset-0 w-full h-full object-cover transition-transform duration-1000 group-hover:scale-105"
                    />
                    {/* Delikatny overlay */}
                    <div class="absolute inset-0 ring-1 ring-inset ring-white/10 rounded-[2rem] md:rounded-[3rem] pointer-events-none"></div>
                </div>
            </div>
        )}

        {/* --- TREŚĆ ARTYKUŁU --- */}
        {/* Zmiana: max-w-3xl -> max-w-4xl (szersza kolumna tekstu) */}
        <div class="max-w-4xl mx-auto px-6 relative">
            
            {/* Opcjonalny Spis treści (Desktop) - Pływający po lewej */}
            {headings && headings.length > 0 && (
                <div class="hidden 2xl:block absolute left-[-260px] top-0 w-56 h-full">
                    <div class="sticky top-32">
                        <h4 class="text-xs font-bold text-zinc-400 uppercase tracking-widest mb-4 pl-3">W tym artykule</h4>
                        <ul class="space-y-1 border-l border-zinc-100">
                            {headings.filter(h => h.depth <= 2).map(heading => (
                                <li>
                                    <a href={`#${heading.slug}`} class="block pl-3 py-1 text-xs text-zinc-500 hover:text-emerald-600 hover:border-l hover:border-emerald-500 -ml-px transition-all truncate">
                                        {heading.text}
                                    </a>
                                </li>
                            ))}
                        </ul>
                    </div>
                </div>
            )}

            {/* Markdown Content */}
            <div class="prose prose-zinc prose-lg md:prose-xl max-w-none 
                prose-headings:font-extrabold prose-headings:tracking-tight prose-headings:text-zinc-900 
                prose-h1:text-3xl md:prose-h1:text-4xl 
                prose-p:text-zinc-600 prose-p:leading-relaxed 
                prose-a:text-emerald-600 prose-a:font-semibold prose-a:no-underline hover:prose-a:text-emerald-500 hover:prose-a:underline
                prose-img:rounded-3xl prose-img:shadow-xl prose-img:my-12 prose-img:ring-1 prose-img:ring-black/5
                prose-blockquote:border-l-4 prose-blockquote:border-emerald-500 prose-blockquote:bg-zinc-50 prose-blockquote:py-4 prose-blockquote:px-8 prose-blockquote:rounded-r-2xl prose-blockquote:not-italic prose-blockquote:font-medium prose-blockquote:text-zinc-800
                prose-code:bg-zinc-100 prose-code:text-emerald-700 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded-md prose-code:before:content-none prose-code:after:content-none
                prose-li:marker:text-emerald-500">
                
                <Content />
                
            </div>

            {/* --- SEKCJA SHARE & AUTHOR --- */}
            <div class="mt-20 pt-10 border-t border-zinc-100">
                <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="flex items-center gap-4">
                        <span class="text-sm font-bold text-zinc-900">Udostępnij:</span>
                        <div class="flex gap-2">
                            {/* Proste przyciski udostępniania */}
                            <button class="w-10 h-10 rounded-full bg-zinc-50 hover:bg-blue-50 text-zinc-400 hover:text-blue-600 flex items-center justify-center transition-colors" title="Facebook">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                            </button>
                            <button class="w-10 h-10 rounded-full bg-zinc-50 hover:bg-sky-50 text-zinc-400 hover:text-sky-500 flex items-center justify-center transition-colors" title="Twitter / X">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>
                            </button>
                            <button class="w-10 h-10 rounded-full bg-zinc-50 hover:bg-blue-50 text-zinc-400 hover:text-blue-700 flex items-center justify-center transition-colors" title="LinkedIn">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                            </button>
                        </div>
                    </div>
                    <a href={`/${post.data.lang}/blog`} class="text-sm font-bold text-zinc-500 hover:text-emerald-600 transition-colors">
                        Zobacz wszystkie wpisy →
                    </a>
                </div>
            </div>

        </div>

    </article>
</BaseLayout>

<script>
    // Prosty skrypt do paska postępu
    document.addEventListener('astro:page-load', () => {
        const progressBar = document.getElementById('progress-bar');
        window.addEventListener('scroll', () => {
            const scrollTop = window.scrollY;
            const docHeight = document.body.scrollHeight - window.innerHeight;
            const scrollPercent = (scrollTop / docHeight) * 100;
            if(progressBar) progressBar.style.width = scrollPercent + '%';
        });
    });
</script>